<ПравилаОбмена>
	<ВерсияФормата РежимСовместимости="РежимСовместимостиСБСП20">2.01</ВерсияФормата>
	<Ид>db809e57-1852-43dc-bdef-5481852481be    </Ид>
	<Наименование>ABSOLUT_CRM --&gt; УправлениеТорговлей</Наименование>
	<ДатаВремяСоздания>2017-11-10T13:51:10</ДатаВремяСоздания>
	<Источник ВерсияПлатформы="8.0" ВерсияКонфигурации="1.0.0.3" СинонимКонфигурации="CRM ABSOLUT ">ABSOLUT_CRM</Источник>
	<Приемник ВерсияПлатформы="8.0" ВерсияКонфигурации="10.3.32.2" СинонимКонфигурации="Управление торговлей, редакция 10.3">УправлениеТорговлей</Приемник>
	<ПослеЗагрузкиДанных>Для Каждого Элемент Из Параметры.СписокДокументовНаПроведение Цикл
	
	ДокОбъект = Элемент.Значение.ПолучитьОбъект();
	Попытка
		Если Элемент.Пометка Тогда
			ДокОбъект.Записать(РежимЗаписиДокумента.Проведение);
			Сообщить("Успешно проведен документ: " + ДокОбъект.Ссылка);
		ИначеЕсли ДокОбъект.Проведен Тогда
			ДокОбъект.Записать(РежимЗаписиДокумента.ОтменаПроведения);
			Сообщить("Успешно распроведен документ: " + ДокОбъект.Ссылка);
		КонецЕсли;
	Исключение
		Сообщить("Не удалось провести документ: " + ДокОбъект.Ссылка); 
		Сообщить(ОписаниеОшибки(), СтатусСообщения.Внимание);
	КонецПопытки;
	
КонецЦикла;</ПослеЗагрузкиДанных>
	<ПослеЗагрузкиПараметров>Параметры.Вставить("СписокДокументовНаПроведение", Новый СписокЗначений);</ПослеЗагрузкиПараметров>
	<Параметры/>
	<Обработки/>
	<ПравилаКонвертацииОбъектов>
		<Группа>
			<Код>Справочники</Код>
			<Наименование>Справочники</Наименование>
			<Порядок>50</Порядок>
			<Правило>
				<Код>Номенклатура</Код>
				<Наименование>Справочник: Номенклатура</Наименование>
				<Порядок>50</Порядок>
				<НеЗамещать>true</НеЗамещать>
				<СинхронизироватьПоИдентификатору>true</СинхронизироватьПоИдентификатору>
				<НеВыгружатьОбъектыСвойствПоСсылкам>true</НеВыгружатьОбъектыСвойствПоСсылкам>
				<НеСоздаватьЕслиНеНайден>true</НеСоздаватьЕслиНеНайден>
				<ИспользоватьБыстрыйПоискПриЗагрузке>true</ИспользоватьБыстрыйПоискПриЗагрузке>
				<Источник>СправочникСсылка.Номенклатура</Источник>
				<Приемник>СправочникСсылка.Номенклатура</Приемник>
				<Свойства/>
				<Значения/>
			</Правило>
			<Правило>
				<Код>Склады</Код>
				<Наименование>Справочник: Склады</Наименование>
				<Порядок>100</Порядок>
				<НеЗамещать>true</НеЗамещать>
				<СинхронизироватьПоИдентификатору>true</СинхронизироватьПоИдентификатору>
				<НеСоздаватьЕслиНеНайден>true</НеСоздаватьЕслиНеНайден>
				<Источник>СправочникСсылка.Склады</Источник>
				<Приемник>СправочникСсылка.Склады</Приемник>
				<Свойства/>
				<Значения/>
			</Правило>
			<Правило>
				<Код>Пользователи</Код>
				<Наименование>Справочник: Пользователи</Наименование>
				<Порядок>150</Порядок>
				<НеЗамещать>true</НеЗамещать>
				<НеСоздаватьЕслиНеНайден>true</НеСоздаватьЕслиНеНайден>
				<ИспользоватьБыстрыйПоискПриЗагрузке>true</ИспользоватьБыстрыйПоискПриЗагрузке>
				<Приемник>СправочникСсылка.Пользователи</Приемник>
				<Свойства>
					<Свойство Поиск="true">
						<Код>3</Код>
						<Наименование>--&gt; Код</Наименование>
						<Порядок>50</Порядок>
						<Источник Имя="" Вид=""/>
						<Приемник Имя="Код" Вид="Свойство" Тип="Строка"/>
						<ПередВыгрузкой>Значение = Источник;</ПередВыгрузкой>
					</Свойство>
				</Свойства>
				<Значения/>
			</Правило>
			<Правило>
				<Код>Организации</Код>
				<Наименование>: </Наименование>
				<Порядок>200</Порядок>
				<НеЗамещать>true</НеЗамещать>
				<НеСоздаватьЕслиНеНайден>true</НеСоздаватьЕслиНеНайден>
				<ИспользоватьБыстрыйПоискПриЗагрузке>true</ИспользоватьБыстрыйПоискПриЗагрузке>
				<Приемник>СправочникСсылка.Организации</Приемник>
				<Свойства>
					<Свойство Поиск="true">
						<Код>1</Код>
						<Наименование>--&gt; Код</Наименование>
						<Порядок>50</Порядок>
						<Источник Имя="" Вид=""/>
						<Приемник Имя="Код" Вид="Свойство" Тип="Строка"/>
						<ПередВыгрузкой>Значение = Источник;</ПередВыгрузкой>
					</Свойство>
				</Свойства>
				<Значения/>
			</Правило>
			<Правило>
				<Код>Подразделения</Код>
				<Наименование>: </Наименование>
				<Порядок>250</Порядок>
				<НеЗамещать>true</НеЗамещать>
				<НеСоздаватьЕслиНеНайден>true</НеСоздаватьЕслиНеНайден>
				<ИспользоватьБыстрыйПоискПриЗагрузке>true</ИспользоватьБыстрыйПоискПриЗагрузке>
				<Приемник>СправочникСсылка.Подразделения</Приемник>
				<Свойства>
					<Свойство Поиск="true">
						<Код>1</Код>
						<Наименование>--&gt; Наименование</Наименование>
						<Порядок>50</Порядок>
						<Источник Имя="" Вид=""/>
						<Приемник Имя="Наименование" Вид="Свойство" Тип="Строка"/>
						<ПередВыгрузкой>Значение = Источник;</ПередВыгрузкой>
					</Свойство>
				</Свойства>
				<Значения/>
			</Правило>
			<Правило>
				<Код>СтатьиЗатрат</Код>
				<Наименование>: </Наименование>
				<Порядок>300</Порядок>
				<НеЗамещать>true</НеЗамещать>
				<НеСоздаватьЕслиНеНайден>true</НеСоздаватьЕслиНеНайден>
				<ИспользоватьБыстрыйПоискПриЗагрузке>true</ИспользоватьБыстрыйПоискПриЗагрузке>
				<Приемник>СправочникСсылка.СтатьиЗатрат</Приемник>
				<Свойства>
					<Свойство Поиск="true">
						<Код>1</Код>
						<Наименование>--&gt; Код</Наименование>
						<Порядок>50</Порядок>
						<Источник Имя="" Вид=""/>
						<Приемник Имя="Код" Вид="Свойство" Тип="Строка"/>
						<ПередВыгрузкой>Значение = Источник;</ПередВыгрузкой>
					</Свойство>
				</Свойства>
				<Значения/>
			</Правило>
			<Правило>
				<Код>Проекты</Код>
				<Наименование>Справочник: Отчеты</Наименование>
				<Порядок>350</Порядок>
				<НеЗамещать>true</НеЗамещать>
				<СинхронизироватьПоИдентификатору>true</СинхронизироватьПоИдентификатору>
				<ПродолжитьПоискПоПолямПоискаЕслиПоИдентификаторуНеНашли>true</ПродолжитьПоискПоПолямПоискаЕслиПоИдентификаторуНеНашли>
				<Источник>СправочникСсылка.Проекты</Источник>
				<Приемник>СправочникСсылка.Проекты</Приемник>
				<Свойства>
					<Свойство Поиск="true">
						<Код>1</Код>
						<Наименование>Наименование --&gt; Наименование</Наименование>
						<Порядок>50</Порядок>
						<Источник Имя="Наименование" Вид="Свойство" Тип="Строка"/>
						<Приемник Имя="Наименование" Вид="Свойство" Тип="Строка"/>
					</Свойство>
				</Свойства>
				<Значения/>
			</Правило>
			<Правило>
				<Код>Причины</Код>
				<Наименование>Справочник: Причины</Наименование>
				<Порядок>400</Порядок>
				<НеЗамещать>true</НеЗамещать>
				<СинхронизироватьПоИдентификатору>true</СинхронизироватьПоИдентификатору>
				<НеСоздаватьЕслиНеНайден>true</НеСоздаватьЕслиНеНайден>
				<Источник>СправочникСсылка.Причины</Источник>
				<Приемник>СправочникСсылка.Причины</Приемник>
				<Свойства/>
				<Значения/>
			</Правило>
		</Группа>
		<Группа>
			<Код>Константы</Код>
			<Наименование>Константы</Наименование>
			<Порядок>100</Порядок>
			<Правило>
				<Код>КонстантыНабор</Код>
				<Наименование>Набор констант: Набор констант</Наименование>
				<Порядок>150</Порядок>
				<НеЗапоминатьВыгруженные>true</НеЗапоминатьВыгруженные>
				<Источник>КонстантыНабор</Источник>
				<Приемник>КонстантыНабор</Приемник>
				<Свойства>
					<Свойство>
						<Код>1</Код>
						<Наименование>ДатаЗапретаРедактированияДокументовВыдачиПодарков --&gt; ДатаЗапретаРедактированияДокументовВыдачиПодар</Наименование>
						<Порядок>50</Порядок>
						<Источник Имя="ДатаЗапретаРедактированияДокументовВыдачиПодарков" Вид="Реквизит" Тип="Дата"/>
						<Приемник Имя="ДатаЗапретаРедактированияДокументовВыдачиПодарков" Вид="Реквизит" Тип="Дата"/>
					</Свойство>
				</Свойства>
				<Значения/>
			</Правило>
		</Группа>
		<Группа>
			<Код>Документы</Код>
			<Наименование>Документы</Наименование>
			<Порядок>150</Порядок>
			<Правило>
				<Код>ТребованиеНакладная</Код>
				<Наименование>Документ: Выдача подарков</Наименование>
				<Порядок>50</Порядок>
				<ПослеЗагрузки>
Для Каждого СтрокаТабличнойЧасти Из Объект.Материалы Цикл
	
	// Выполнить общие действия для всех документов при изменении номенклатуры.
	ОбработкаТабличныхЧастей.ПриИзмененииНоменклатурыТабЧасти(СтрокаТабличнойЧасти, Объект);

	СтрокаТабличнойЧасти.ЕдиницаИзмерения = СтрокаТабличнойЧасти.Номенклатура.ЕдиницаХраненияОстатков;
	СтрокаТабличнойЧасти.Коэффициент      = СтрокаТабличнойЧасти.ЕдиницаИзмерения.Коэффициент;

	ОбработкаТабличныхЧастей.ЗаполнитьЕдиницуМестТабЧасти(СтрокаТабличнойЧасти, Объект, Ложь);

	Если ЗначениеЗаполнено(СтрокаТабличнойЧасти.Номенклатура) Тогда

		//СтрокаТабличнойЧасти.СтатьяЗатрат         = СтрокаТабличнойЧасти.Номенклатура.СтатьяЗатрат;
		СтрокаТабличнойЧасти.НоменклатурнаяГруппа = СтрокаТабличнойЧасти.Номенклатура.НоменклатурнаяГруппаЗатрат;

	КонецЕсли;

	СтрокаТабличнойЧасти.Качество = Справочники.Качество.Новый;	
	
КонецЦикла;

Если ОбъектНайден И ПараметрыОбъекта["ПометкаУдаления"] Тогда
	Объект.Записать(РежимЗаписиДокумента.Запись);
	Объект.УстановитьПометкуУдаления(Истина);
ИначеЕсли ОбъектНайден И НЕ ПараметрыОбъекта["ПометкаУдаления"] И Объект.ПометкаУдаления Тогда
	Объект.Записать(РежимЗаписиДокумента.Запись);
	Объект.УстановитьПометкуУдаления(Ложь);
Иначе
	Объект.Записать(РежимЗаписиДокумента.Запись);
КонецЕсли;

ОбъектМодифицирован = Ложь;
Параметры.СписокДокументовНаПроведение.Добавить(Объект.Ссылка, , ПараметрыОбъекта["Проведен"]);</ПослеЗагрузки>
				<СинхронизироватьПоИдентификатору>true</СинхронизироватьПоИдентификатору>
				<ПродолжитьПоискПоПолямПоискаЕслиПоИдентификаторуНеНашли>true</ПродолжитьПоискПоПолямПоискаЕслиПоИдентификаторуНеНашли>
				<Источник>ДокументСсылка.ВыдачаПодарков</Источник>
				<Приемник>ДокументСсылка.ТребованиеНакладная</Приемник>
				<Свойства>
					<Свойство Поиск="true">
						<Код>1</Код>
						<Наименование>Дата --&gt; Дата</Наименование>
						<Порядок>50</Порядок>
						<Источник Имя="Дата" Вид="Свойство" Тип="Дата"/>
						<Приемник Имя="Дата" Вид="Свойство" Тип="Дата"/>
					</Свойство>
					<Свойство Поиск="true">
						<Код>2</Код>
						<Наименование>Номер --&gt; Номер</Наименование>
						<Порядок>100</Порядок>
						<Источник Имя="Номер" Вид="Свойство" Тип="Строка"/>
						<Приемник Имя="Номер" Вид="Свойство" Тип="Строка"/>
						<ПриводитьКДлине>11</ПриводитьКДлине>
					</Свойство>
					<Группа>
						<Код>7</Код>
						<Наименование>Подарки --&gt; Материалы</Наименование>
						<Порядок>150</Порядок>
						<Источник Имя="Подарки" Вид="ТабличнаяЧасть"/>
						<Приемник Имя="Материалы" Вид="ТабличнаяЧасть"/>
						<ПередОбработкойВыгрузки>Запрос = Новый Запрос;
Запрос.Текст = 
"ВЫБРАТЬ
|	ВыдачаПодарковПодарки.Подарок,
|	ВыдачаПодарковПодарки.Количество
|ПОМЕСТИТЬ вт_НеСгруппированныйРезультат
|ИЗ
|	Документ.ВыдачаПодарков.Подарки КАК ВыдачаПодарковПодарки
|ГДЕ
|	НЕ ВыдачаПодарковПодарки.Подарок.Комплект
|	И ВыдачаПодарковПодарки.Ссылка = &amp;Ссылка
|
|ОБЪЕДИНИТЬ ВСЕ
|
|ВЫБРАТЬ
|	НоменклатураКомплектующие.Номенклатура,
|	ВыдачаПодарковПодарки.Количество * НоменклатураКомплектующие.Количество
|ИЗ
|	Справочник.Номенклатура.Комплектующие КАК НоменклатураКомплектующие
|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ВыдачаПодарков.Подарки КАК ВыдачаПодарковПодарки
|		ПО НоменклатураКомплектующие.Ссылка = ВыдачаПодарковПодарки.Подарок
|ГДЕ
|	ВыдачаПодарковПодарки.Подарок.Комплект
|	И ВыдачаПодарковПодарки.Ссылка = &amp;Ссылка
|;
|
|////////////////////////////////////////////////////////////////////////////////
|ВЫБРАТЬ
|	вт_НеСгруппированныйРезультат.Подарок,
|	СУММА(вт_НеСгруппированныйРезультат.Количество) КАК Количество
|ИЗ
|	вт_НеСгруппированныйРезультат КАК вт_НеСгруппированныйРезультат
|
|СГРУППИРОВАТЬ ПО
|	вт_НеСгруппированныйРезультат.Подарок";

Запрос.УстановитьПараметр("Ссылка", Источник);
РезультатЗапроса = Запрос.Выполнить();

Если НЕ РезультатЗапроса.Пустой() Тогда

	КоллекцияОбъектов = РезультатЗапроса.Выгрузить(); 

КонецЕсли;</ПередОбработкойВыгрузки>
						<Свойство>
							<Код>8</Код>
							<Наименование>Количество --&gt; Количество</Наименование>
							<Порядок>50</Порядок>
							<Источник Имя="Количество" Вид="Реквизит" Тип="Число"/>
							<Приемник Имя="Количество" Вид="Реквизит" Тип="Число"/>
						</Свойство>
						<Свойство>
							<Код>9</Код>
							<Наименование>Подарок --&gt; Номенклатура</Наименование>
							<Порядок>100</Порядок>
							<Источник Имя="Подарок" Вид="Реквизит" Тип="СправочникСсылка.Номенклатура"/>
							<Приемник Имя="Номенклатура" Вид="Реквизит" Тип="СправочникСсылка.Номенклатура"/>
							<КодПравилаКонвертации>Номенклатура                                      </КодПравилаКонвертации>
						</Свойство>
						<Свойство>
							<Код>10</Код>
							<Наименование>--&gt; СтатьяЗатрат</Наименование>
							<Порядок>150</Порядок>
							<Источник Имя="" Вид=""/>
							<Приемник Имя="СтатьяЗатрат" Вид="Реквизит" Тип="СправочникСсылка.СтатьиЗатрат"/>
							<КодПравилаКонвертации>СтатьиЗатрат                                      </КодПравилаКонвертации>
							<ПередВыгрузкой>Значение = "000000001"; //Основное производство</ПередВыгрузкой>
						</Свойство>
					</Группа>
					<Свойство>
						<Код>3</Код>
						<Наименование>Ответственный --&gt; Ответственный</Наименование>
						<Порядок>200</Порядок>
						<Источник Имя="Ответственный" Вид="Реквизит" Тип="СправочникСсылка.Пользователи"/>
						<Приемник Имя="Ответственный" Вид="Реквизит" Тип="СправочникСсылка.Пользователи"/>
						<КодПравилаКонвертации>Пользователи                                      </КодПравилаКонвертации>
						<ПередВыгрузкой>Значение = "Автообмен";</ПередВыгрузкой>
					</Свойство>
					<Свойство>
						<Код>6</Код>
						<Наименование>Склад --&gt; Склад</Наименование>
						<Порядок>250</Порядок>
						<Источник Имя="Склад" Вид="Реквизит" Тип="СправочникСсылка.Склады"/>
						<Приемник Имя="Склад" Вид="Реквизит" Тип="СправочникСсылка.Склады"/>
						<КодПравилаКонвертации>Склады                                            </КодПравилаКонвертации>
					</Свойство>
					<Свойство>
						<Код>4</Код>
						<Наименование>ПометкаУдаления --&gt; ПометкаУдаления</Наименование>
						<Порядок>300</Порядок>
						<Источник Имя="ПометкаУдаления" Вид="Свойство" Тип="Булево"/>
						<Приемник Имя="" Вид=""/>
						<ИмяПараметраДляПередачи>ПометкаУдаления</ИмяПараметраДляПередачи>
					</Свойство>
					<Свойство>
						<Код>5</Код>
						<Наименование>Проведен --&gt; Проведен</Наименование>
						<Порядок>350</Порядок>
						<Источник Имя="Проведен" Вид="Свойство" Тип="Булево"/>
						<Приемник Имя="" Вид=""/>
						<ИмяПараметраДляПередачи>Проведен</ИмяПараметраДляПередачи>
					</Свойство>
					<Свойство>
						<Код>11</Код>
						<Наименование>--&gt; ОтражатьВУправленческомУчете</Наименование>
						<Порядок>400</Порядок>
						<Источник Имя="" Вид=""/>
						<Приемник Имя="ОтражатьВУправленческомУчете" Вид="Реквизит" Тип="Булево"/>
						<ПередВыгрузкой>Значение = Истина;</ПередВыгрузкой>
					</Свойство>
					<Свойство>
						<Код>12</Код>
						<Наименование>--&gt; Организация</Наименование>
						<Порядок>450</Порядок>
						<Источник Имя="" Вид=""/>
						<Приемник Имя="Организация" Вид="Реквизит" Тип="СправочникСсылка.Организации"/>
						<КодПравилаКонвертации>Организации                                       </КодПравилаКонвертации>
						<ПередВыгрузкой>Значение = "000000001"; //ООО "Группа Абсолют"</ПередВыгрузкой>
					</Свойство>
					<Свойство>
						<Код>13</Код>
						<Наименование>--&gt; Подразделение</Наименование>
						<Порядок>500</Порядок>
						<Источник Имя="" Вид=""/>
						<Приемник Имя="Подразделение" Вид="Реквизит" Тип="СправочникСсылка.Подразделения"/>
						<КодПравилаКонвертации>Подразделения                                     </КодПравилаКонвертации>
						<ПередВыгрузкой>Значение = "ОМиР";</ПередВыгрузкой>
					</Свойство>
					<Свойство>
						<Код>14</Код>
						<Наименование>--&gt; Комментарий</Наименование>
						<Порядок>550</Порядок>
						<Источник Имя="" Вид=""/>
						<Приемник Имя="Комментарий" Вид="Реквизит" Тип="Строка"/>
						<ПередВыгрузкой>Значение = "Создан автоматически на основании документа """ + Источник + """ базы CRM";</ПередВыгрузкой>
					</Свойство>
				</Свойства>
				<Значения/>
			</Правило>
		</Группа>
	</ПравилаКонвертацииОбъектов>
	<ПравилаВыгрузкиДанных>
		<Группа Отключить="false">
			<Код>Документы</Код>
			<Наименование>Документы</Наименование>
			<Порядок>50</Порядок>
			<Правило Отключить="false">
				<Код>ВыдачаПодарков</Код>
				<Наименование>ВыдачаПодарков</Наименование>
				<Порядок>50</Порядок>
				<КодПравилаКонвертации>ТребованиеНакладная                               </КодПравилаКонвертации>
				<СпособОтбораДанных>СтандартнаяВыборка</СпособОтбораДанных>
				<ОбъектВыборки>ДокументСсылка.ВыдачаПодарков</ОбъектВыборки>
			</Правило>
		</Группа>
		<Правило Отключить="false">
			<Код>КонстантыНабор</Код>
			<Наименование>КонстантыНабор</Наименование>
			<Порядок>100</Порядок>
			<КодПравилаКонвертации>КонстантыНабор                                    </КодПравилаКонвертации>
			<СпособОтбораДанных>СтандартнаяВыборка</СпособОтбораДанных>
			<ОбъектВыборки>КонстантыНабор</ОбъектВыборки>
		</Правило>
	</ПравилаВыгрузкиДанных>
	<ПравилаОчисткиДанных/>
	<Алгоритмы/>
	<Запросы/>
</ПравилаОбмена>